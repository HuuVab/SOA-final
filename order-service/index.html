<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce Order Management</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --info: #6366f1;
            --light: #f8fafc;
            --border: #e2e8f0;
            --text: #334155;
            --text-light: #64748b;
            --gray: #94a3b8;
            --dark: #1e293b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            background: var(--light);
            color: var(--text);
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1, h2, h3 {
            margin-bottom: 15px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        
        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }
        
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            font-weight: 500;
            transition: background-color 0.3s;
            text-decoration: none;
            font-size: 14px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .order-list {
            display: grid;
            gap: 15px;
        }
        
        .order-item {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            background: white;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .order-id {
            font-weight: 600;
            color: var(--primary);
        }
        
        .order-date {
            color: var(--text-light);
            font-size: 14px;
        }
        
        .order-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-shipped {
            background: #cffafe;
            color: #155e75;
        }
        
        .status-delivered {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .detail-item {
            background: var(--light);
            padding: 15px;
            border-radius: 6px;
        }
        
        .detail-label {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .alert {
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            flex: 1;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .order-items {
            margin-top: 20px;
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 60px 2fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .item-row:last-child {
            border-bottom: none;
        }
        
        .item-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            background: var(--light);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .timeline {
            position: relative;
            padding-left: 25px;
            margin-top: 20px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            height: 100%;
            width: 2px;
            background: var(--border);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -21px;
            top: 5px;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--primary);
        }
        
        .timeline-date {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .timeline-content {
            font-weight: 500;
        }
        
        .timeline-notes {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .status-updates {
            background: var(--light);
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .customer-info {
            background: var(--light);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .customer-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .customer-email {
            color: var(--text-light);
        }
        
        .hidden {
            display: none !important;
        }
        
        .admin-header {
            background: var(--dark);
            color: white;
            padding: 10px 20px;
            margin: -20px -20px 20px -20px;
        }
        
        .reports-section {
            margin-top: 30px;
        }
        
        .report-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- Add this element anywhere in the body -->
    <div id="alert" class="alert" style="display: none;"></div>
    <div class="container">
        
        <div id="adminDashboard">
            <div class="admin-header">
                <div class="header" style="background: transparent; box-shadow: none; margin-bottom: 0;">
                    <div>
                        <h1 style="color: white;">Order Dashboard</h1>
                        <div style="font-size: 14px; color: #94a3b8;">Order Management System</div>
                    </div>
                    <!-- Removed logout button -->
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchAdminTab('overview')">Overview</div>
                <div class="tab" onclick="switchAdminTab('orders')">Orders</div>
            </div>
            
            <!-- Overview Tab -->
            <div id="overviewTab">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Orders</div>
                        <div class="stat-value" id="totalOrders">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-value" id="totalRevenue">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Order Value</div>
                        <div class="stat-value" id="avgOrderValue">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Orders</div>
                        <div class="stat-value" id="activeOrders">0</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Order Status Overview</div>
                    <div class="card-body">
                        <div id="statusChart" class="chart-container"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Daily Order Trend</div>
                    <div class="card-body">
                        <div id="trendChart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- Orders Tab -->
            <div id="ordersTab" class="hidden">
                <div class="filters">
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="statusFilter" class="form-control">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Start Date</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="filter-group">
                        <label>End Date</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                    </div>
                </div>
                
                <div class="search-bar">
                    <input type="text" id="adminSearch" class="form-control" placeholder="Search orders, tracking numbers, products...">
                    <button class="btn btn-primary" onclick="adminSearchOrders()">Search</button>
                </div>
                
                <div class="loading" id="adminLoading">Loading orders...</div>
                
                <div id="adminOrderList" class="order-list">
                    <!-- Admin orders will be populated here -->
                </div>
                
                <div class="pagination" id="pagination">
                    <!-- Pagination will be populated here -->
                </div>
            </div>
            
            
    <!-- Remove Customer Order List section -->
    
    <!-- Remove Order Details Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Order Details</h2>
                <span class="close" onclick="closeOrderModal()">&times;</span>
            </div>
            <div id="orderModalContent">
                <!-- Order details will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Update Status Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Update Order Status</h2>
                <span class="close" onclick="closeStatusModal()">&times;</span>
            </div>
            <form id="statusForm">
                <input type="hidden" id="statusOrderId">
                <div class="form-group">
                    <label>Status</label>
                    <select id="newStatus" class="form-control" required>
                        <option value="">Select status...</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="statusNotes" class="form-control" rows="3" placeholder="Optional notes..."></textarea>
                </div>
                <div id="shippingFields" style="display: none;">
                    <div class="form-group">
                        <label>Tracking Number</label>
                        <input type="text" id="trackingNumber" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Carrier</label>
                        <input type="text" id="carrier" class="form-control">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </form>
        </div>
    </div>
    
    <!-- Remove Cancel Order Modal -->
    
    <script>
        // Configuration
        const API_URL = '/api';
        
        // Current state
        let currentPage = 1;
        let currentAdminTab = 'overview';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {

            loadAdminDashboard();
            setupFormEvents();
        });
        
        // Remove login functions
        // Form Event Handlers
        function setupFormEvents() {
            // Remove login form handler
            
            // Status form
            document.getElementById('statusForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateOrderStatus();
            });
            
            // Cancel form - No longer needed since admin can't cancel orders
            
            // New status change handler
            document.getElementById('newStatus').addEventListener('change', (e) => {
                const shippingFields = document.getElementById('shippingFields');
                if (e.target.value === 'shipped') {
                    shippingFields.style.display = 'block';
                } else {
                    shippingFields.style.display = 'none';
                }
            });
        }
        
        // Remove authentication functions
        
        // Remove all customer functions (loadCustomerOrders, renderCustomerOrders, customerSearchOrders)
        
        // Search Functions
        async function loadAdminDashboard() {
            if (currentAdminTab === 'overview') {
                await loadStatistics();
            } else if (currentAdminTab === 'orders') {
                await loadAdminOrders();
            }
        }
        
        function switchAdminTab(tab) {
            currentAdminTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Show/hide tab content
            document.getElementById('overviewTab').classList.toggle('hidden', tab !== 'overview');
            document.getElementById('ordersTab').classList.toggle('hidden', tab !== 'orders');

            
            // Load data for the selected tab
            loadAdminDashboard();
        }
        
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_URL}/admin/orders/stats`);
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const stats = result.statistics;
                    
                    // Update stat cards
                    document.getElementById('totalOrders').textContent = stats.total_orders || 0;
                    document.getElementById('totalRevenue').textContent = `${stats.total_revenue ? parseFloat(stats.total_revenue).toFixed(2) : '0.00'}`;
                    document.getElementById('avgOrderValue').textContent = `${stats.average_order_value ? parseFloat(stats.average_order_value).toFixed(2) : '0.00'}`;
                    
                    // Calculate active orders (pending + processing)
                    const activeStatus = stats.status_breakdown.filter(s => 
                        s.status === 'pending' || s.status === 'processing'
                    );
                    const activeCount = activeStatus.reduce((sum, s) => sum + s.count, 0);
                    document.getElementById('activeOrders').textContent = activeCount;
                    
                    // Render charts
                    renderStatusChart(stats.status_breakdown);
                    renderTrendChart(stats.daily_trend);
                }
            } catch (error) {
                showAlert('error', 'Error loading statistics');
            }
        }
        
        function renderStatusChart(data) {
            const chart = document.getElementById('statusChart');
            
            // Simple bar chart
            let html = '<div style="display: flex; align-items: flex-end; height: 250px; gap: 20px; padding: 20px;">';
            
            const maxCount = Math.max(...data.map(d => d.count));
            
            data.forEach(item => {
                const height = (item.count / maxCount) * 200;
                const color = getStatusColor(item.status);
                
                html += `
                    <div style="flex: 1; text-align: center;">
                        <div style="height: ${height}px; background: ${color}; margin-bottom: 10px; border-radius: 4px;"></div>
                        <div style="font-size: 12px; font-weight: 500;">${item.status}</div>
                        <div style="font-size: 14px;">${item.count}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            chart.innerHTML = html;
        }
        
        function renderTrendChart(data) {
            const chart = document.getElementById('trendChart');
            
            if (!data || data.length === 0) {
                chart.innerHTML = '<p>No data available</p>';
                return;
            }
            
            // Reverse data to show oldest to newest
            data.reverse();
            
            // Simple line chart
            let html = '<div style="position: relative; height: 250px; padding: 20px;">';
            
            const maxOrders = Math.max(...data.map(d => d.orders));
            const width = (100 / data.length);
            
            // Draw lines
            data.forEach((item, index) => {
                const height = (item.orders / maxOrders) * 200;
                const x = index * width;
                
                if (index < data.length - 1) {
                    const nextHeight = (data[index + 1].orders / maxOrders) * 200;
                    html += `<div style="position: absolute; left: ${x}%; bottom: ${height}px; width: ${width}%; height: 2px; background: var(--primary); transform-origin: left;"></div>`;
                }
                
                html += `
                    <div style="position: absolute; left: ${x}%; bottom: ${height}px; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; transform: translate(-50%, 50%);"></div>
                    <div style="position: absolute; left: ${x}%; bottom: -20px; font-size: 10px; transform: translate(-50%, 0);">${formatDate(item.date, true)}</div>
                `;
            });
            
            html += '</div>';
            chart.innerHTML = html;
        }
        
        async function loadAdminOrders(page = 1) {
            const loading = document.getElementById('adminLoading');
            const list = document.getElementById('adminOrderList');
            
            loading.classList.add('show');
            list.innerHTML = '';
            
            try {
                const params = new URLSearchParams({
                    page: page,
                    per_page: 20
                });
                
                const status = document.getElementById('statusFilter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (status) params.append('status', status);
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                
                const response = await fetch(`${API_URL}/admin/orders?${params}`);
                
                const result = await response.json();
                loading.classList.remove('show');
                
                if (result.status === 'success') {
                    renderAdminOrders(result.orders);
                    renderPagination(result.pagination);
                } else {
                    showAlert('error', result.message);
                }
            } catch (error) {
                loading.classList.remove('show');
                showAlert('error', 'Error loading orders');
            }
        }
        
        function renderAdminOrders(orders) {
            const list = document.getElementById('adminOrderList');
            
            if (!orders || orders.length === 0) {
                list.innerHTML = '<p>No orders found</p>';
                return;
            }
            
            orders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-item';
                orderDiv.innerHTML = `
                    <div class="order-header">
                        <div>
                            <span class="order-id">Order #${order.order_id.substring(0, 8)}</span>
                            <span class="order-date">${formatDate(order.created_at)}</span>
                        </div>
                        <span class="order-status status-${order.status}">${order.status}</span>
                    </div>
                    ${order.customer ? `
                        <div class="customer-info">
                            <div class="customer-name">${order.customer.first_name} ${order.customer.last_name}</div>
                            <div class="customer-email">${order.customer.email}</div>
                        </div>
                    ` : ''}
                    <div class="order-details">
                        <div class="detail-item">
                            <div class="detail-label">Total Amount</div>
                            <div class="detail-value">${parseFloat(order.total_amount).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Items</div>
                            <div class="detail-value">${order.items ? order.items.length : 0} items</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Payment Method</div>
                            <div class="detail-value">${order.payment_method_id.substring(0, 8)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Tracking</div>
                            <div class="detail-value">${order.tracking_number || 'N/A'}</div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-small" onclick="viewAdminOrder('${order.order_id}')">View Details</button>
                        <button class="btn btn-primary btn-small" onclick="openStatusModal('${order.order_id}', '${order.status}')">Update Status</button>
                    </div>
                `;
                list.appendChild(orderDiv);
            });
        }
        
        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            
            let html = '';
            
            // Previous button
            if (pagination.page > 1) {
                html += `<button class="btn btn-secondary btn-small" onclick="loadAdminOrders(${pagination.page - 1})">Previous</button>`;
            }
            
            // Page info
            html += `<span style="padding: 8px 16px;">Page ${pagination.page} of ${pagination.pages}</span>`;
            
            // Next button
            if (pagination.page < pagination.pages) {
                html += `<button class="btn btn-secondary btn-small" onclick="loadAdminOrders(${pagination.page + 1})">Next</button>`;
            }
            
            container.innerHTML = html;
        }
        
        // Search Functions
        async function adminSearchOrders() {
            const searchInput = document.getElementById('adminSearch');
            const query = searchInput.value.trim();
            
            if (!query) {
                loadAdminOrders();
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/orders/search?q=${encodeURIComponent(query)}`);
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    renderAdminOrders(result.orders);
                }
            } catch (error) {
                showAlert('error', 'Error searching orders');
            }
        }
        
        // Order Details
        async function viewAdminOrder(orderId) {
            await showOrderDetails(orderId, true);
        }
        
        async function showOrderDetails(orderId, isAdmin) {
            const modal = document.getElementById('orderModal');
            const content = document.getElementById('orderModalContent');
            
            content.innerHTML = '<div class="loading">Loading order details...</div>';
            modal.style.display = 'flex';
            
            try {
                const endpoint = `/admin/orders/${orderId}`;
                const response = await fetch(`${API_URL}${endpoint}`);
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const order = result.order;
                    renderOrderDetails(order, isAdmin);
                } else {
                    content.innerHTML = `<p>Error: ${result.message}</p>`;
                }
            } catch (error) {
                content.innerHTML = `<p>Error loading order details</p>`;
            }
        }
        
        function renderOrderDetails(order, isAdmin) {
            const content = document.getElementById('orderModalContent');
            
            let html = `
                <div class="detail-item">
                    <div class="detail-label">Order ID</div>
                    <div class="detail-value">${order.order_id}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="order-status status-${order.status}">${order.status}</span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Created</div>
                    <div class="detail-value">${formatDate(order.created_at)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Total Amount</div>
                    <div class="detail-value">${parseFloat(order.total_amount).toFixed(2)}</div>
                </div>
            `;
            
            if (order.customer) {
                html += `
                    <div class="customer-info">
                        <h3>Customer Information</h3>
                        <div class="customer-name">${order.customer.first_name} ${order.customer.last_name}</div>
                        <div class="customer-email">${order.customer.email}</div>
                        ${order.customer.phone ? `<div>Phone: ${order.customer.phone}</div>` : ''}
                    </div>
                `;
            }
            
            if (order.shipping_address) {
                html += `
                    <div class="customer-info">
                        <h3>Shipping Address</h3>
                        <div>${order.shipping_address.address_line1}</div>
                        ${order.shipping_address.address_line2 ? `<div>${order.shipping_address.address_line2}</div>` : ''}
                        <div>${order.shipping_address.city}, ${order.shipping_address.state} ${order.shipping_address.postal_code}</div>
                        <div>${order.shipping_address.country}</div>
                    </div>
                `;
            }
            
            if (order.tracking_number || order.carrier) {
                html += `
                    <div class="customer-info">
                        <h3>Tracking Information</h3>
                        ${order.tracking_number ? `<div>Tracking Number: ${order.tracking_number}</div>` : ''}
                        ${order.carrier ? `<div>Carrier: ${order.carrier}</div>` : ''}
                    </div>
                `;
            }
            
            html += '<h3>Order Items</h3>';
            html += '<div class="order-items">';
            
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    html += `
                        <div class="item-row">
                            ${item.product_image ? 
                                `<img src="${item.product_image}" alt="${item.product_name}" class="item-image">` :
                                `<div class="item-image" style="background: var(--light);"></div>`
                            }
                            <div>
                                <div>${item.product_name}</div>
                                <div style="font-size: 12px; color: var(--text-light);">Product ID: ${item.product_id}</div>
                            </div>
                            <div>${item.quantity}</div>
                            <div>${parseFloat(item.price).toFixed(2)}</div>
                            <div>${(item.quantity * item.price).toFixed(2)}</div>
                        </div>
                    `;
                });
            } else {
                html += '<p>No items found</p>';
            }
            
            html += '</div>';
            
            // Order status history
            if (order.status_history && order.status_history.length > 0) {
                html += '<h3>Status History</h3>';
                html += '<div class="timeline">';
                
                order.status_history.forEach(history => {
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-date">${formatDate(history.created_at)}</div>
                            <div class="timeline-content">${history.status}</div>
                            ${history.notes ? `<div class="timeline-notes">${history.notes}</div>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            content.innerHTML = html;
        }
        
        // Modal Functions
        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        function openStatusModal(orderId, currentStatus) {
            document.getElementById('statusOrderId').value = orderId;
            document.getElementById('newStatus').value = currentStatus;
            document.getElementById('statusNotes').value = '';
            document.getElementById('trackingNumber').value = '';
            document.getElementById('carrier').value = '';
            document.getElementById('shippingFields').style.display = 'none';
            document.getElementById('statusModal').style.display = 'flex';
        }
        
        function closeStatusModal() {
            document.getElementById('statusModal').style.display = 'none';
        }
        
        // Action Functions
        async function updateOrderStatus() {
    const orderId = document.getElementById('statusOrderId').value;
    const status = document.getElementById('newStatus').value;
    const notes = document.getElementById('statusNotes').value;
    const trackingNumber = document.getElementById('trackingNumber').value;
    const carrier = document.getElementById('carrier').value;
    
    const data = { status };
    if (notes) data.notes = notes;
    if (trackingNumber) data.tracking_number = trackingNumber;
    if (carrier) data.carrier = carrier;
    
    try {
        const response = await fetch(`${API_URL}/admin/orders/${orderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert('success', 'Order status updated successfully');
            closeStatusModal();
            loadAdminOrders(currentPage);
        } else {
            showAlert('error', result.message);
        }
    } catch (error) {
        showAlert('error', 'Error updating status');
    }
}
        
        // Remove cancelOrder function
        
        // Report Functions
        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const format = document.getElementById('reportFormat').value;
            
            try {
                const params = new URLSearchParams({
                    type: reportType,
                    start_date: startDate,
                    end_date: endDate,
                    format: format
                });
                
                const response = await fetch(`${API_URL}/admin/orders/reports?${params}`);
                
                if (format === 'csv') {
                    // Handle CSV download
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `order_report_${reportType}_${startDate}_${endDate}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    // Display JSON report
                    const result = await response.json();
                    const reportResult = document.getElementById('reportResult');
                    const reportContent = document.getElementById('reportContent');
                    
                    reportContent.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                    reportResult.style.display = 'block';
                }
            } catch (error) {
                showAlert('error', 'Error generating report');
            }
        }
        
        // Utility Functions
        function formatDate(dateString, dateOnly = false) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            
            if (dateOnly) {
                return date.toLocaleDateString();
            }
            
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        function getStatusColor(status) {
            const colors = {
                'pending': '#f59e0b',
                'processing': '#3b82f6',
                'shipped': '#06b6d4',
                'delivered': '#10b981',
                'cancelled': '#ef4444'
            };
            return colors[status] || '#94a3b8';
        }
        
        function showAlert(type, message) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        function applyFilters() {
            loadAdminOrders(1); // Reset to page 1 when applying filters
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = [
                document.getElementById('orderModal'), 
                document.getElementById('statusModal')
            ];
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>